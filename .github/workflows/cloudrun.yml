name: Build and Deploy to Cloud Run
env:
  IMAGE: resume-generator
  TAG: latest

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        project_id: ceritadata-3704
        credentials_json: ${{ secrets.ARTIFACT_REGISTRY_SA }}
    - name: Configure Google Artifact Registry
      run: |
        gcloud auth configure-docker ${{ vars.REGION }}-docker.pkg.dev
    - name: Build and push Docker image
      run: |
        IMAGE_NAME=${{ vars.REGION }}-docker.pkg.dev/${{ vars.PROJECT_ID }}/${{ vars.REPOSITORY }}/$IMAGE:$TAG
        docker build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

      outputs:
        image: ${{ steps.build-and-push.outputs.IMAGE_NAME }}

  deploy-to-cloud-run:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    - name: Deploy to Cloud Run
      id: deploy
      uses: google-github-actions/deploy-cloudrun@v0
      with:
        service: $SERVICE
        region: ${{ vars.REGION }}
        image: ${{ needs.build-and-push.outputs.image }}
